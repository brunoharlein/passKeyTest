<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>Test Passkeys</title></head>
<body>
<h2>Test Passkeys avec Symfony API</h2>
<input id="email" value="test@asso.fr" />
<button onclick="register()">1) Register</button>
<button onclick="login()">2) Login</button>
<pre id="out"></pre>

<script>
const out = (m) => document.getElementById("out").textContent += "\n" + m;

function b64uToBuf(b64) {
  b64 = b64.replace(/-/g, "+").replace(/_/g, "/");
  const pad = "=".repeat((4 - (b64.length % 4)) % 4);
  const bin = atob(b64 + pad);
  const bytes = new Uint8Array(bin.length);
  for (let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
  return bytes.buffer;
}

function bufToB64u(buf) {
  const bytes = new Uint8Array(buf);
  let bin = "";
  bytes.forEach(b => bin += String.fromCharCode(b));
  return btoa(bin).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
}

async function register() {
  const email = document.getElementById("email").value;
  const options = await fetch("/webauthn/register/start", {
    method: "POST", headers: {"Content-Type":"application/json"},
    body: JSON.stringify({email})
  }).then(r=>r.json());

  options.challenge = b64uToBuf(options.challenge);
  options.user.id = b64uToBuf(options.user.id);

  const cred = await navigator.credentials.create({ publicKey: options });

  const payload = {
    email,
    credential: {
      id: cred.id,
      rawId: bufToB64u(cred.rawId),
      type: cred.type,
      response: {
        clientDataJSON: bufToB64u(cred.response.clientDataJSON),
        attestationObject: bufToB64u(cred.response.attestationObject)
      }
    }
  };

  const res = await fetch("/webauthn/register/finish", {
    method: "POST", headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  }).then(r=>r.json());

  out("REGISTER: " + JSON.stringify(res, null, 2));
}

async function login() {
  const email = document.getElementById("email").value;
  const options = await fetch("/webauthn/login/start", {
    method: "POST", headers: {"Content-Type":"application/json"},
    body: JSON.stringify({email})
  }).then(r=>r.json());

  if (!options.challenge) { out("LOGIN START error: "+JSON.stringify(options)); return; }

  options.challenge = b64uToBuf(options.challenge);
  options.allowCredentials = options.allowCredentials.map(c => ({
    type: "public-key",
    id: b64uToBuf(c.id)
  }));

  const cred = await navigator.credentials.get({ publicKey: options });

  const payload = {
    email,
    credential: {
      id: cred.id,
      rawId: bufToB64u(cred.rawId),
      type: cred.type,
      response: {
        clientDataJSON: bufToB64u(cred.response.clientDataJSON),
        authenticatorData: bufToB64u(cred.response.authenticatorData),
        signature: bufToB64u(cred.response.signature)
      }
    }
  };

  const res = await fetch("/webauthn/login/finish", {
    method: "POST", headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  }).then(r=>r.json());

  out("LOGIN: " + JSON.stringify(res, null, 2));
}
</script>
</body>
</html>
